<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>eResus - Cardiac Arrest Scribe</title>

    <!-- PWA and Mobile App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#111827">
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogImVSZXN1cyIsCiAgInNob3J0X25hbWUiOiAiZVJlc3VzIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMxMTE4MjciLAogICJ0aGVtZV9jb2xvciI6ICIjMTEyRDQ2IiwKICAiZGVzY3JpcHRpb24iOiAiQSBjbGluaWNhbCBzY3JpYmUgZm9yIG91dC1vZi1ob3NwaXRhbCBjYXJkaWFjIGFycmVzdHMuIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly8xNDU5NTUyMjIuZnMxLmh1YnNwb3R1c2VyY29udGVudC1ldTEubmV0L2h1YmZzLzEIVCQ5NTUyMjIvZUmVzdXMuanBnIiwKICAgICAgInNpemVzIjogIjE5MngxOTIgNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL2pwZWciCiAgICAgICJ9CiAgXQp9">
    <link rel="apple-touch-icon" href="https://145955222.fs1.hubspotusercontent-eu1.net/hubfs/145955222/eResus.jpg">
    <link rel="icon" href="https://145955222.fs1.hubspotusercontent-eu1.net/hubfs/145955222/eResus.jpg">

    <!-- Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      /* Simple scrollbar styling */
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: #1f2937; }
      ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
      
      /* Amiodarone pulse animation */
      @keyframes pulse-purple {
        0%, 100% {
          box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.4);
        }
        50% {
          box-shadow: 0 0 0 4px rgba(168, 85, 247, 0);
        }
      }
      .animate-pulse-purple {
        animation: pulse-purple 2s infinite;
      }
    </style>
</head>
<body class="bg-gray-900">
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>

    <!-- All React Application Code -->
    <script type="module">
        import React, { useReducer, useEffect, useRef, useState } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';

        // --- SERVICE WORKER REGISTRATION FOR OFFLINE CAPABILITY ---
        const registerServiceWorker = () => {
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
              .then(registration => console.log('ServiceWorker registration successful with scope: ', registration.scope))
              .catch(err => console.log('ServiceWorker registration failed: ', err));
          }
        };
        
        registerServiceWorker();


        // --- TYPES AND CONSTANTS ---
        const REVERSIBLE_CAUSES = { Hypoxia: false, Hypovolemia: false, 'Hypo/Hyperkalaemia': false, Hypothermia: false, Toxins: false, Tamponade: false, 'Tension Pneumothorax': false, Thrombosis: false };
        const POST_ROSC_TASKS = { 'Optimise Ventilation & Oxygenation': false, '12-Lead ECG': false, 'Treat Hypotension (SBP < 90)': false, 'Check Blood Glucose': false, 'Consider Temperature Control': false, 'Identify & Treat Causes': false };
        const POST_MORTEM_TASKS = { 'Reposition body & remove lines/tubes': false, 'Complete documentation': false, 'Determine expected/unexpected death': false, 'Contact Coroner (if unexpected)': false, 'Follow local body handling procedure': false, 'Provide leaflet to bereaved relatives': false, 'Consider organ/tissue donation': false };
        const OTHER_DRUGS = ['Adenosine', 'Atropine', 'Adrenaline 1:1000', 'Adrenaline 1:10,000', 'Amiodarone (Further Dose)', 'Calcium chloride', 'Glucose', 'Hartmann’s solution', 'Magnesium sulphate', 'Midazolam', 'Naloxone', 'Potassium chloride', 'Sodium bicarbonate', 'Sodium chloride', 'Tranexamic acid'];
        const CPR_CYCLE_SECONDS = 120;
        const ADRENALINE_INTERVAL_SECONDS = 240;
        const HYPOTHERMIC_ADRENALINE_INTERVAL_SECONDS = 480; // Doubled interval
        const METRONOME_BPM = 110;

        // --- ICONS (React Components) ---
        const SyringeIcon = () => React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: 'h-5 w-5 mr-2 inline-block', fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor', strokeWidth: "2" }, React.createElement(React.Fragment, null, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M14 4l6 6m-4-4l4 4' }), React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M16 10l-8.5 8.5a2.121 2.121 0 01-3-3L13 7' }), React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M8 16l-3.5 3.5' }), React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M4 12l2 2' })));
        const BoltIcon = () => React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: 'h-5 w-5 mr-2 inline-block', fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor' }, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M13 10V3L4 14h7v7l9-11h-7z' }));
        const HeartPulseIcon = () => React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: 'h-5 w-5 mr-2 inline-block', fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor' }, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z' }));
        const StopIcon = () => React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: 'h-5 w-5 mr-2 inline-block', fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor' }, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z' }));
        const MusicNoteIcon = () => React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: 'h-8 w-8', fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor' }, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2z' }));
        const CheckCircleIcon = ({ checked, status }) => {
            let colorClass = 'text-slate-600';
            if (status === 'severe') colorClass = 'text-blue-400';
            else if (status === 'moderate') colorClass = 'text-yellow-400';
            else if (checked) colorClass = 'text-green-400';

            return React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: `h-6 w-6 mr-3 flex-shrink-0 ${colorClass}`, fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor' }, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' }));
        };
        const AirwayIcon = () => React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: 'h-5 w-5 mr-2 inline-block', fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor', strokeWidth: "2" }, React.createElement(React.Fragment, null, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M12 6v12m0-12a6 6 0 016 6v0a6 6 0 01-6 6m0-12a6 6 0 00-6 6v0a6 6 0 006 6' }), React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M12 3v3' })));
        const LungsIcon = () => React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: 'h-5 w-5 mr-2 inline-block', fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor', strokeWidth: "2" }, React.createElement(React.Fragment, null, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M6 21V12a6 6 0 1112 0v9' }), React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M12 12V3' }), React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M8 8l-2-2' }), React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M16 8l2-2' })));
        const IosShareIcon = () => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-8 w-8 mx-auto mb-1 text-blue-500", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor", strokeWidth: "1.5" }, React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" }));
        const AndroidMenuIcon = () => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-8 w-8 mx-auto mb-1", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor", strokeWidth: "2" }, React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" }));
        const ExternalLinkIcon = () => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-5 w-5 ml-2", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor", strokeWidth: "2" }, React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" }));

        // --- CORE APPLICATION LOGIC ---
        const formatTime = (timeInSeconds) => {
            const minutes = Math.floor(timeInSeconds / 60).toString().padStart(2, '0');
            const seconds = (timeInSeconds % 60).toString().padStart(2, '0');
            return `${minutes}:${seconds}`;
        };

        const triggerHapticFeedback = (duration = 50) => {
            if (navigator.vibrate) { navigator.vibrate(duration); }
        };

        const initialState = {
            arrestState: 'PENDING',
            startTime: null, masterTime: 0, cprTime: CPR_CYCLE_SECONDS,
            cprCycleStartTime: 0, lastAdrenalineTime: null, events: [],
            adrenalineCount: 0, amiodaroneCount: 0, lidocaineCount: 0,
            shockCount: 0, airwayPlaced: false, uiState: 'default',
            metronomeOn: false, reversibleCauses: { ...REVERSIBLE_CAUSES },
            postRoscTasks: { ...POST_ROSC_TASKS }, 
            postMortemTasks: { ...POST_MORTEM_TASKS },
            antiarrhythmicGiven: null,
            previousState: null, shockCountOnAmiodarone1: null,
            timeOffset: 0,
        };

        const appReducer = (state, action) => {
            if (state.arrestState === 'ENDED' && !['RESET', 'TOGGLE_METRONOME', 'UNDO', 'TOGGLE_POST_MORTEM_TASK'].includes(action.type)) {
                return state;
            }
             if (state.arrestState === 'PENDING' && !['START_ARREST', 'RESET', 'ADD_TIME_OFFSET'].includes(action.type)) {
                return state;
            }
            
            const totalArrestTime = (state.masterTime || 0) + state.timeOffset;
            const newEvent = (message, type) => ({ timestamp: totalArrestTime, message, type });

            switch (action.type) {
                case 'ADD_TIME_OFFSET': {
                    if (state.arrestState === 'ENDED' || state.arrestState === 'ROSC') return state;
                    const newOffset = state.timeOffset + action.payload;
                    const eventTimestamp = (state.masterTime || 0) + state.timeOffset;
                    const event = { timestamp: eventTimestamp, message: `Time offset added: +${action.payload / 60} min`, type: 'status' };
                    return { ...state, timeOffset: newOffset, events: [...state.events, event] };
                }
                case 'START_ARREST': {
                    const startTime = Date.now();
                    const startEvent = { timestamp: state.timeOffset, message: `Arrest Started at ${new Date(startTime).toLocaleTimeString()}`, type: 'status' };
                    const initialEvents = state.events.length > 0 && state.events[0].message.includes('offset') ? [...state.events, startEvent] : [startEvent];
                    return { ...state, arrestState: 'ACTIVE', startTime, events: initialEvents, cprCycleStartTime: state.timeOffset };
                }
                case 'TICK': {
                    if (!state.startTime) return state;
                    const newMasterTime = Math.floor((Date.now() - state.startTime) / 1000); // This is the running time
                    const newTotalArrestTime = newMasterTime + state.timeOffset;

                    if (state.arrestState === 'ROSC') return { ...state, masterTime: newMasterTime };
                    if (state.arrestState !== 'ACTIVE') return state;
                    
                    let newCprTime = CPR_CYCLE_SECONDS - (newTotalArrestTime - state.cprCycleStartTime);
                    if (newCprTime > 0 && newCprTime <= 10) {
                        triggerHapticFeedback(200);
                    }
                    let events = state.events, cprCycleStartTime = state.cprCycleStartTime;
                    if (newCprTime < 0) {
                        newCprTime = CPR_CYCLE_SECONDS;
                        cprCycleStartTime = newTotalArrestTime;
                        events = [...state.events, { timestamp: newTotalArrestTime, message: 'CPR Cycle Complete. New cycle started.', type: 'cpr' }];
                    }
                    return { ...state, masterTime: newMasterTime, cprTime: newCprTime, events, cprCycleStartTime };
                }
                case 'SET_HYPOTHERMIA_STATUS': {
                    const newReversibleCauses = { ...state.reversibleCauses, Hypothermia: action.payload };
                    let message = `Hypothermia status set to: ${action.payload}`;
                    if(action.payload === 'normothermic') message = 'Hypothermia status cleared.';
                    return { ...state, previousState: state, reversibleCauses: newReversibleCauses, events: [...state.events, newEvent(message, 'status')] };
                }
                case 'TOGGLE_REVERSIBLE_CAUSE': {
                    const cause = action.payload;
                    const currentValue = state.reversibleCauses[cause];
                    const newValue = !currentValue;
                    const newReversibleCauses = { ...state.reversibleCauses, [cause]: newValue };
                    const causeMessage = `Reversible Cause: ${cause} ${newValue ? 'considered/excluded' : 'unchecked'}.`;
                    return { ...state, previousState: state, reversibleCauses: newReversibleCauses, events: [...state.events, newEvent(causeMessage, 'cause')] };
                }
                case 'LOG_OTHER_DRUG':
                    return { ...state, previousState: state, events: [...state.events, newEvent(`${action.payload} Given`, 'drug')] };
                case 'LOG_AMIODARONE': {
                    if (state.amiodaroneCount >= 2 || state.antiarrhythmicGiven === 'lidocaine' || state.reversibleCauses.Hypothermia === 'severe') return state;
                    const newAmiodaroneCount = state.amiodaroneCount + 1;
                    const amioMessage = newAmiodaroneCount === 1 ? 'Amiodarone (300mg) Given - Dose 1' : 'Amiodarone (150mg) Given - Dose 2';
                    const shockCountOnAmiodarone1 = newAmiodaroneCount === 1 ? state.shockCount : state.shockCountOnAmiodarone1;
                    return { ...state, previousState: state, amiodaroneCount: newAmiodaroneCount, antiarrhythmicGiven: 'amiodarone', shockCountOnAmiodarone1, events: [...state.events, newEvent(amioMessage, 'drug')] };
                }
                case 'DELIVER_SHOCK':
                    const newShockCount = state.shockCount + 1;
                    return { ...state, previousState: state, shockCount: newShockCount, uiState: 'default', cprCycleStartTime: totalArrestTime, events: [...state.events, newEvent(`Shock ${newShockCount} Delivered. Resuming CPR.`, 'shock')] };
                case 'LOG_ADRENALINE':
                    if (state.reversibleCauses.Hypothermia === 'severe') return state;
                    const newAdrenalineCount = state.adrenalineCount + 1;
                    return { ...state, previousState: state, adrenalineCount: newAdrenalineCount, lastAdrenalineTime: totalArrestTime, events: [...state.events, newEvent(`Adrenaline (1mg) Given - Dose ${newAdrenalineCount}`, 'drug')] };
                case 'END_ARREST':
                    const endTime = new Date();
                    return { ...state, previousState: state, arrestState: 'ENDED', cprTime: 0, events: [...state.events, newEvent(`Arrest Ended (Patient Deceased) at ${endTime.toLocaleTimeString()}`, 'status')] };
                case 'START_RHYTHM_ANALYSIS':
                    return { ...state, previousState: state, uiState: 'analyzing', events: [...state.events, newEvent('Rhythm Analysis Paused', 'analysis')] };
                case 'LOG_RHYTHM_TYPE':
                    if(action.payload === 'ROSC') {
                        return { ...state, previousState: state, uiState: 'default', arrestState: 'ROSC', cprTime: 0, events: [...state.events, newEvent('Return of Spontaneous Circulation (ROSC)', 'status')] };
                    }
                    const isShockable = action.payload === 'VF' || action.payload === 'VT';
                    return { ...state, previousState: state, uiState: isShockable ? 'shock_advised' : 'default', events: [...state.events, newEvent(`Rhythm is ${action.payload}`, 'rhythm')] };
                case 'LOG_LIDOCAINE':
                    if (state.lidocaineCount >= 2 || state.antiarrhythmicGiven === 'amiodarone') return state;
                    const newLidocaineCount = state.lidocaineCount + 1;
                    return { ...state, previousState: state, lidocaineCount: newLidocaineCount, antiarrhythmicGiven: 'lidocaine', events: [...state.events, newEvent(`Lidocaine Given - Dose ${newLidocaineCount}`, 'drug')] };
                case 'LOG_AIRWAY':
                    if (state.airwayPlaced) return state;
                    return { ...state, previousState: state, airwayPlaced: true, events: [...state.events, newEvent('Advanced Airway Placed', 'airway')] };
                case 'LOG_ETCO2':
                    return { ...state, previousState: state, events: [...state.events, newEvent(`ETCO2: ${action.payload} mmHg`, 'etco2')] };
                case 'LOG_ROSC':
                    return { ...state, previousState: state, uiState: 'default', arrestState: 'ROSC', cprTime: 0, shockCountOnAmiodarone1: null, events: [...state.events, newEvent('Return of Spontaneous Circulation (ROSC)', 'status')] };
                case 'RE_ARREST':
                    return { ...state, previousState: state, arrestState: 'ACTIVE', cprCycleStartTime: totalArrestTime, events: [...state.events, newEvent('Patient Re-Arrested. CPR Resumed.', 'status')]};
                case 'TOGGLE_METRONOME':
                    return { ...state, metronomeOn: !state.metronomeOn };
                case 'TOGGLE_POST_ROSC_TASK':
                    const updatedTasks = { ...state.postRoscTasks, [action.payload]: !state.postRoscTasks[action.payload] };
                    const taskMessage = `Post-ROSC Care: ${action.payload} ${updatedTasks[action.payload] ? 'completed' : 'unchecked'}.`;
                    return { ...state, previousState: state, postRoscTasks: updatedTasks, events: [...state.events, newEvent(taskMessage, 'status')] };
                case 'TOGGLE_POST_MORTEM_TASK':
                    const updatedMortemTasks = { ...state.postMortemTasks, [action.payload]: !state.postMortemTasks[action.payload] };
                    const mortemTaskMessage = `Post-Mortem Care: ${action.payload} ${updatedMortemTasks[action.payload] ? 'completed' : 'unchecked'}.`;
                    return { ...state, previousState: state, postMortemTasks: updatedMortemTasks, events: [...state.events, newEvent(mortemTaskMessage, 'status')] };
                case 'UNDO':
                    return state.previousState || state;
                case 'RESET':
                    return { ...initialState, reversibleCauses: { ...REVERSIBLE_CAUSES }, postRoscTasks: { ...POST_ROSC_TASKS }, postMortemTasks: { ...POST_MORTEM_TASKS }};
                default:
                    return state;
            }
        };

        // --- UI HELPER COMPONENTS ---
        const getLogColorClass = (type) => {
            switch (type) {
                case 'status': return 'text-green-400'; case 'cpr': return 'text-cyan-400'; case 'shock': return 'text-amber-400';
                case 'analysis': return 'text-blue-400'; case 'rhythm': return 'text-purple-400'; case 'drug': return 'text-orange-400';
                case 'airway': return 'text-indigo-400'; case 'etco2': return 'text-teal-400'; case 'cause': return 'text-slate-400';
                default: return 'text-slate-300';
            }
        };

        const ArrestStatusIndicator = ({ status }) => {
            const statusStyles = { PENDING: { text: 'PENDING', className: 'bg-slate-500' }, ACTIVE: { text: 'ACTIVE', className: 'bg-red-500 animate-pulse' }, ROSC: { text: 'ROSC', className: 'bg-green-500' }, ENDED: { text: 'ENDED', className: 'bg-slate-700' } };
            const { text, className } = statusStyles[status];
            return React.createElement('div', { className: 'flex items-center gap-2' }, React.createElement('span', { className: `px-2 py-1 text-xs font-bold tracking-wider text-white rounded ${className}` }, text));
        };

        const CircularProgress = ({ cprTime, cycleEnded }) => {
            const percentage = (cprTime / CPR_CYCLE_SECONDS) * 100, radius = 56, circumference = 2 * Math.PI * radius;
            const strokeDashoffset = cprTime >= 0 ? circumference - (percentage / 100) * circumference : circumference;
            const flashClass = cycleEnded ? 'animate-ping-once' : '', timeColorClass = cprTime > 0 && cprTime <= 10 ? 'text-red-500 animate-pulse' : 'text-cyan-400';
            return React.createElement('div', { className: `relative w-40 h-40 ${flashClass}` }, React.createElement('svg', { className: 'w-full h-full transform -rotate-90', viewBox: '0 0 120 120' }, React.createElement('circle', { cx: '60', cy: '60', r: radius, strokeWidth: '8', className: 'text-slate-700', stroke: 'currentColor', fill: 'transparent' }), React.createElement('circle', { cx: '60', cy: '60', r: radius, strokeWidth: '8', className: 'text-cyan-400', stroke: 'currentColor', fill: 'transparent', strokeLinecap: 'round', strokeDasharray: circumference, strokeDashoffset: strokeDashoffset, style: { transition: 'stroke-dashoffset 0.5s linear' } })), React.createElement('div', { className: 'absolute inset-0 flex flex-col items-center justify-center', 'aria-live': 'polite' }, React.createElement('span', { className: `text-4xl font-mono ${timeColorClass}` }, formatTime(Math.max(0, cprTime))), React.createElement('span', { className: 'text-xs text-slate-400 tracking-wider' }, 'CPR CYCLE')));
        };
        
        const AdrenalineTimer = ({ masterTime, lastAdrenalineTime, interval }) => {
            if (lastAdrenalineTime === null) return null;
            const timeSince = masterTime - lastAdrenalineTime;
            const timeRemaining = interval - timeSince;
            if (timeRemaining <= 0) {
                triggerHapticFeedback(500);
                return React.createElement(AdrenalineDueWarning);
            }
            return React.createElement('div', { className: 'bg-gray-700 border border-gray-600 rounded-lg p-3 text-center flex items-center justify-center shadow-md' }, React.createElement(SyringeIcon), React.createElement('span', { className: 'text-lg font-semibold text-slate-200 ml-3' }, 'Adrenaline due in: ', React.createElement('span', { className: 'font-mono text-xl' }, formatTime(timeRemaining))));
        };
        const AdrenalineDueWarning = () => React.createElement('div', { className: 'bg-red-600/90 border-2 border-red-500 rounded-lg p-3 text-center animate-pulse flex items-center justify-center shadow-lg' }, React.createElement(SyringeIcon), React.createElement('span', { className: 'text-xl font-bold text-white ml-3' }, 'Adrenaline Due'));
        const AmiodaroneReminder = () => {
            triggerHapticFeedback(500);
            return React.createElement('div', { className: 'bg-purple-800/50 border border-purple-600 rounded-lg p-3 text-center flex items-center justify-center shadow-md animate-pulse-purple' }, React.createElement(SyringeIcon), React.createElement('span', { className: 'text-lg font-semibold text-slate-200 ml-3' }, 'Consider 2nd Amiodarone Dose'));
        };
        const ActionButton = ({ children, className = '', disabled = false, largeText = false, ...props }) => {
            const finalClassName = `w-full h-20 flex flex-col items-center justify-center p-2 text-center rounded-xl shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 transition-all transform active:scale-95 disabled:opacity-40 disabled:cursor-not-allowed disabled:active:scale-100 disabled:bg-slate-700 ${largeText ? 'text-xl' : 'text-md'} font-semibold ${className}`;
            const handleClick = (e) => { if (!disabled && props.onClick) { triggerHapticFeedback(); props.onClick(e); } };
            return React.createElement('button', { ...props, onClick: handleClick, disabled, className: finalClassName }, children);
        };

        const Checklist = ({ title, items, onToggle, onHypothermiaClick }) => {
            return React.createElement('div', { className: 'bg-gray-800/50 rounded-lg p-4' }, 
                React.createElement('h2', { className: 'text-lg font-bold mb-4 text-slate-200' }, title),
                React.createElement('div', { className: 'grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3' }, 
                    Object.entries(items).map(([item, value]) => {
                        const isHypothermia = item === 'Hypothermia';
                        const isChecked = isHypothermia ? value !== false : value;
                        const isCrossedOut = isHypothermia ? value === 'normothermic' : value;

                        let statusText = '';
                        if (isHypothermia) {
                            if (value === 'severe') statusText = ': Severe';
                            if (value === 'moderate') statusText = ': Moderate';
                        }
                        
                        return React.createElement('div', { 
                            key: item, 
                            onClick: () => isHypothermia && onHypothermiaClick ? onHypothermiaClick() : onToggle(item), 
                            className: 'flex items-center cursor-pointer p-2 -m-2 rounded-md hover:bg-gray-700/50' 
                        }, 
                            React.createElement(CheckCircleIcon, { checked: isChecked, status: isHypothermia ? value : null }), 
                            React.createElement('span', { className: `transition-colors ${isCrossedOut ? 'line-through text-slate-500' : 'text-slate-300'}` }, item + statusText)
                        );
                    })
                )
            );
        };
        
        const SummaryModal = ({ events, onClose, masterTime }) => {
            const summaryText = `eResus Event Summary\nTotal Arrest Time: ${formatTime(masterTime)}\n\n--- Event Log ---\n${events.map(e => `[${formatTime(e.timestamp)}] ${e.message}`).join('\n')}`;
            const [copied, setCopied] = useState(false);
            const handleCopy = () => { navigator.clipboard.writeText(summaryText).then(() => { setCopied(true); setTimeout(() => setCopied(false), 2000); }); };
            return React.createElement('div', { className: 'fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50' }, React.createElement('div', { className: 'bg-gray-800 rounded-lg shadow-xl w-full max-w-lg max-h-full flex flex-col border border-gray-700' }, React.createElement('div', { className: 'p-4 border-b border-gray-700 flex justify-between items-center' }, React.createElement('h2', { className: 'text-xl font-bold' }, 'Event Summary'), React.createElement('button', { onClick: onClose, className: 'text-slate-400 hover:text-white text-2xl' }, '×')), React.createElement('div', { className: 'p-4 overflow-y-auto' }, React.createElement('pre', { className: 'text-sm whitespace-pre-wrap bg-gray-900 p-3 rounded-md text-slate-200' }, summaryText)), React.createElement('div', { className: 'p-4 border-t border-gray-700 flex gap-4' }, React.createElement('button', { onClick: handleCopy, className: 'flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg' }, copied ? 'Copied!' : 'Copy to Clipboard'), React.createElement('button', { onClick: onClose, className: 'flex-1 bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg' }, 'Close'))));
        };

        const ResetModal = ({ events, masterTime, onClose, onReset }) => {
            const [copied, setCopied] = useState(false);
            const handleCopyAndReset = () => { const summaryText = `eResus Event Summary\nTotal Arrest Time: ${formatTime(masterTime)}\n\n--- Event Log ---\n${events.map(e => `[${formatTime(e.timestamp)}] ${e.message}`).join('\n')}`; navigator.clipboard.writeText(summaryText).then(() => { setCopied(true); setTimeout(() => { onReset(); }, 1000); }); };
            return React.createElement('div', { className: 'fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50' }, React.createElement('div', { className: 'bg-gray-800 rounded-lg shadow-xl w-full max-w-sm border border-gray-700 text-center' }, React.createElement('div', { className: 'p-6' }, React.createElement('h2', { className: 'text-xl font-bold' }, 'Reset Arrest Log?'), React.createElement('p', { className: 'text-slate-400 mt-2' }, 'This action cannot be undone. You can copy the log to your clipboard before resetting.')), React.createElement('div', { className: 'p-4 flex flex-col gap-3 border-t border-gray-700' }, React.createElement('button', { onClick: handleCopyAndReset, disabled: copied, className: 'w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg disabled:opacity-50' }, copied ? 'Copied! Resetting...' : 'Copy Log & Reset'), React.createElement('button', { onClick: onReset, className: 'w-full bg-red-800/80 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg' }, 'Reset Anyway'), React.createElement('button', { onClick: onClose, className: 'w-full text-slate-300 hover:bg-gray-700 font-bold py-2 px-4 rounded-lg mt-1' }, 'Cancel'))));
        };

        const EndArrestModal = ({ onClose, onConfirm }) => React.createElement('div', { className: 'fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50' }, React.createElement('div', { className: 'bg-gray-800 rounded-lg shadow-xl w-full max-w-sm border border-gray-700 text-center' }, React.createElement('div', { className: 'p-6' }, React.createElement('h2', { className: 'text-xl font-bold' }, 'Confirm End of Arrest'), React.createElement('p', { className: 'text-slate-400 mt-2' }, 'This will log the patient as deceased at the current time. This action is final.')), React.createElement('div', { className: 'p-4 flex flex-col gap-3 border-t border-gray-700' }, React.createElement('button', { onClick: onConfirm, className: 'w-full bg-red-800/80 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg' }, 'Confirm (Patient Deceased)'), React.createElement('button', { onClick: onClose, className: 'w-full text-slate-300 hover:bg-gray-700 font-bold py-2 px-4 rounded-lg mt-1' }, 'Cancel'))));
        
        const Etco2Modal = ({ onClose, onConfirm }) => {
            const [value, setValue] = useState(''); const inputRef = useRef(null);
            useEffect(() => { inputRef.current?.focus(); }, []);
            const handleConfirm = () => { if (value.trim()) { onConfirm(value.trim()); } };
            return React.createElement('div', { className: 'fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50' }, React.createElement('div', { className: 'bg-gray-800 rounded-lg shadow-xl w-full max-w-sm border border-gray-700 text-center' }, React.createElement('div', { className: 'p-6' }, React.createElement('h2', { className: 'text-xl font-bold' }, 'Log ETCO2 Value'), React.createElement('p', { className: 'text-slate-400 mt-2' }, 'Enter the current end-tidal CO2 reading in mmHg.'), React.createElement('input', { ref: inputRef, type: 'number', value, onChange: (e) => setValue(e.target.value), onKeyDown: (e) => e.key === 'Enter' && handleConfirm(), className: 'mt-4 w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-center text-xl', placeholder: 'e.g., 35' })), React.createElement('div', { className: 'p-4 flex gap-3 border-t border-gray-700' }, React.createElement('button', { onClick: onClose, className: 'flex-1 text-slate-300 hover:bg-gray-700 font-bold py-3 px-4 rounded-lg' }, 'Cancel'), React.createElement('button', { onClick: handleConfirm, className: 'flex-1 bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg' }, 'Log Value'))));
        };
        
        const InstructionsModal = ({ onClose }) => {
            const isIos = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            const iosInstructions = React.createElement('div', { className: "text-center" }, React.createElement('p', { className: "text-lg" }, "To install this app on your device:"), React.createElement('p', { className: "mt-4" }, "1. Tap the ", React.createElement('strong', null, "Share"), " icon in your browser."), React.createElement(IosShareIcon, null), React.createElement('p', { className: "mt-2" }, "2. Scroll down and tap on"), React.createElement('p', { className: "font-bold mt-1" }, '"Add to Home Screen".'));
            const androidInstructions = React.createElement('div', { className: "text-center" }, React.createElement('p', { className: "text-lg" }, "To install this app on your device:"), React.createElement('p', { className: "mt-4" }, "1. Tap the ", React.createElement('strong', null, "Menu"), " button (3 dots) in your browser."), React.createElement(AndroidMenuIcon, null), React.createElement('p', { className: "mt-2" }, "2. Tap on"), React.createElement('p', { className: "font-bold mt-1" }, '"Install app" or "Add to Home Screen".'));
            return React.createElement('div', { className: "fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center p-4 z-50 text-slate-200" }, React.createElement('div', { className: "bg-gray-800 rounded-xl shadow-xl w-full max-w-sm border border-gray-700 p-6" }, React.createElement('img', { src: "https://145955222.fs1.hubspotusercontent-eu1.net/hubfs/145955222/eResus.jpg", className: "w-24 h-24 mx-auto rounded-3xl mb-4" }), React.createElement('h2', { className: "text-2xl font-bold text-center mb-4" }, "Welcome to eResus"), isIos ? iosInstructions : androidInstructions, React.createElement('button', { onClick: onClose, className: "w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg mt-6" }, "Continue to App")));
        };
        
        const HypothermiaModal = ({ onClose, onConfirm }) => {
            return React.createElement('div', { className: 'fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50' }, 
                React.createElement('div', { className: 'bg-gray-800 rounded-lg shadow-xl w-full max-w-sm border border-gray-700 text-center' },
                    React.createElement('div', { className: 'p-6' },
                        React.createElement('h2', { className: 'text-xl font-bold' }, 'Set Hypothermia Status'),
                        React.createElement('p', { className: 'text-slate-400 mt-2' }, 'Select the patient\'s temperature range to apply the correct guidelines.')
                    ),
                    React.createElement('div', { className: 'p-4 flex flex-col gap-3 border-t border-gray-700' },
                        React.createElement('button', { onClick: () => onConfirm('severe'), className: 'w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg' }, 'Severe (< 30°C)'),
                        React.createElement('button', { onClick: () => onConfirm('moderate'), className: 'w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg' }, 'Moderate (30-35°C)'),
                        React.createElement('button', { onClick: () => onConfirm('normothermic'), className: 'w-full text-slate-300 hover:bg-gray-700 font-bold py-2 px-4 rounded-lg mt-1' }, 'Clear / Normothermic')
                    )
                )
            );
        };

        const ActionSection = ({ title, children }) => React.createElement('div', { className: 'bg-gray-800/50 rounded-lg p-3' }, React.createElement('h2', { className: 'text-sm font-bold mb-3 text-slate-400 tracking-wider uppercase' }, title), React.createElement('div', { className: 'grid grid-cols-2 gap-3' }, children));

        const OtherDrugsModal = ({ onClose, onSelectDrug, drugs }) => {
            return React.createElement('div', { className: 'fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50' }, React.createElement('div', { className: 'bg-gray-800 rounded-lg shadow-xl w-full max-w-sm max-h-[80vh] flex flex-col border border-gray-700' }, React.createElement('div', { className: 'p-4 border-b border-gray-700 flex justify-between items-center' }, React.createElement('h2', { className: 'text-xl font-bold' }, 'Log Other Medication'), React.createElement('button', { onClick: onClose, className: 'text-slate-400 hover:text-white text-2xl' }, '×')), React.createElement('div', { className: 'overflow-y-auto p-2' }, React.createElement('div', { className: 'grid grid-cols-1 gap-2' }, drugs.map(drug => React.createElement('button', { key: drug, onClick: () => onSelectDrug(drug), className: 'w-full text-left bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg' }, drug))))));
        };
        
        const TimeOffsetButtons = ({ dispatch }) => {
            return React.createElement('div', { className: 'flex flex-col space-y-1 ml-2' },
                React.createElement('button', { onClick: () => dispatch({ type: 'ADD_TIME_OFFSET', payload: 60 }), className: 'px-2 py-0.5 text-xs font-semibold text-white bg-slate-600 hover:bg-slate-500 rounded' }, '+1m'),
                React.createElement('button', { onClick: () => dispatch({ type: 'ADD_TIME_OFFSET', payload: 300 }), className: 'px-2 py-0.5 text-xs font-semibold text-white bg-slate-600 hover:bg-slate-500 rounded' }, '+5m'),
                React.createElement('button', { onClick: () => dispatch({ type: 'ADD_TIME_OFFSET', payload: 600 }), className: 'px-2 py-0.5 text-xs font-semibold text-white bg-slate-600 hover:bg-slate-500 rounded' }, '+10m')
            );
        };
        
        const AlgorithmCard = ({ title, href }) => {
            return React.createElement('a', { 
                href, 
                target: '_blank', 
                rel: 'noopener noreferrer', 
                className: 'flex items-center justify-center text-center p-4 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors shadow-md border border-gray-700 font-semibold text-slate-200 h-full' 
            },
                title,
                React.createElement(ExternalLinkIcon)
            );
        };

        const ResuscitationCouncilAlgorithms = ({ arrestState }) => {
            const isRosc = arrestState === 'ROSC';
            const isEnded = arrestState === 'ENDED';
            if (isEnded) return null; // Don't show algorithms on the ended screen

            const renderRoscAlgorithm = () => {
                return React.createElement(AlgorithmCard, {
                    title: 'Post Cardiac Arrest Rehabilitation',
                    href: 'https://www.resus.org.uk/sites/default/files/2023-08/Post%20cardiac%20arrest%20rehabilitation%20algorithim%202023.pdf',
                });
            };

             const renderAlsAlgorithms = () => {
                return React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-4' },
                    React.createElement(AlgorithmCard, {
                        title: 'Adult ALS Algorithm',
                        href: 'https://www.resus.org.uk/sites/default/files/2024-01/Adult%20Advanced%20Life%20Support%20Algorithm%202021%20Aug%202023.pdf',
                    }),
                    React.createElement(AlgorithmCard, {
                        title: 'Paediatric ALS Algorithm',
                        href: 'https://www.resus.org.uk/sites/default/files/2021-04/Paediatric%20ALS%20Algorithm%202021.pdf',
                    }),
                    React.createElement(AlgorithmCard, {
                        title: 'Newborn Life Support',
                        href: 'https://www.resus.org.uk/sites/default/files/2021-05/Newborn%20Life%20Support%20Algorithm%202021.pdf',
                    })
                );
             };

            return React.createElement('div', { className: 'bg-gray-800/50 rounded-lg p-4' },
                React.createElement('h2', { className: 'text-lg font-bold mb-4 text-slate-200' }, isRosc ? 'Post-Resuscitation Care Guideline' : 'Resuscitation Council UK Algorithms'),
                isRosc ? renderRoscAlgorithm() : renderAlsAlgorithms()
            );
        };


        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [state, dispatch] = useReducer(appReducer, initialState);
            const [showOtherDrugsModal, setShowOtherDrugsModal] = useState(false);
            const audioCtxRef = useRef(null), metronomeIntervalRef = useRef(null), timerIdRef = useRef(null);
            const [showSummary, setShowSummary] = useState(false), [showResetModal, setShowResetModal] = useState(false);
            const [showEndArrestModal, setShowEndArrestModal] = useState(false), [showEtco2Modal, setShowEtco2Modal] = useState(false);
            const [cprCycleEnded, setCprCycleEnded] = useState(false), logContainerRef = useRef(null);
            const [showInstructions, setShowInstructions] = useState(false);
            const [showHypothermiaModal, setShowHypothermiaModal] = useState(false);

            useEffect(() => { const hasSeen = localStorage.getItem('eResusInstructionsSeen'); if (!hasSeen) { setShowInstructions(true); } }, []);
            
             useEffect(() => {
                if (timerIdRef.current) clearInterval(timerIdRef.current);
                if (state.arrestState === 'ACTIVE' || state.arrestState === 'ROSC') { timerIdRef.current = window.setInterval(() => dispatch({ type: 'TICK' }), 1000); }
                return () => { if (timerIdRef.current) clearInterval(timerIdRef.current); };
            }, [state.arrestState]);

            useEffect(() => {
                if (state.metronomeOn) {
                    audioCtxRef.current = new (window.AudioContext || window.webkitAudioContext)();
                    const playBeep = () => { if (!audioCtxRef.current) return; const oscillator = audioCtxRef.current.createOscillator(); const gainNode = audioCtxRef.current.createGain(); oscillator.type = 'sine'; oscillator.frequency.setValueAtTime(880, audioCtxRef.current.currentTime); gainNode.gain.setValueAtTime(0.3, audioCtxRef.current.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtxRef.current.currentTime + 0.1); oscillator.connect(gainNode); gainNode.connect(audioCtxRef.current.destination); oscillator.start(); oscillator.stop(audioCtxRef.current.currentTime + 0.1); };
                    const intervalTime = (60 / METRONOME_BPM) * 1000;
                    metronomeIntervalRef.current = window.setInterval(playBeep, intervalTime);
                }
                return () => { if (metronomeIntervalRef.current) clearInterval(metronomeIntervalRef.current); if (audioCtxRef.current?.state !== 'closed') audioCtxRef.current?.close().catch(console.error); };
            }, [state.metronomeOn]);
            
            useEffect(() => { if (logContainerRef.current) logContainerRef.current.scrollTop = 0; }, [state.events]);

            useEffect(() => { if (state.cprTime === CPR_CYCLE_SECONDS && state.arrestState === 'ACTIVE' && state.masterTime > 0) { setCprCycleEnded(true); setTimeout(() => setCprCycleEnded(false), 1000); } }, [state.cprTime, state.arrestState, state.masterTime]);

            const handleCloseInstructions = () => { localStorage.setItem('eResusInstructionsSeen', 'true'); setShowInstructions(false); };
            const handleReset = () => { setShowResetModal(false); dispatch({ type: 'RESET' }); };
            const handleEndArrest = () => { setShowEndArrestModal(false); dispatch({ type: 'END_ARREST' }); };
            const handleLogEtco2 = (value) => { dispatch({ type: 'LOG_ETCO2', payload: value }); setShowEtco2Modal(false); };
            const handleLogOtherDrug = (drug) => { dispatch({ type: 'LOG_OTHER_DRUG', payload: drug }); setShowOtherDrugsModal(false); };
            const handleSetHypothermiaStatus = (status) => {
                dispatch({ type: 'SET_HYPOTHERMIA_STATUS', payload: status });
                setShowHypothermiaModal(false);
            };

            const renderActiveArrestActions = () => {
                const hypothermiaStatus = state.reversibleCauses.Hypothermia;
                switch (state.uiState) {
                    case 'analyzing':
                        return React.createElement(ActionSection, { title: 'Select Rhythm' }, React.createElement(ActionButton, { onClick: () => dispatch({ type: 'LOG_RHYTHM_TYPE', payload: 'VF' }), className: 'bg-amber-500 hover:bg-amber-600 text-black' }, 'VF'), React.createElement(ActionButton, { onClick: () => dispatch({ type: 'LOG_RHYTHM_TYPE', payload: 'VT' }), className: 'bg-amber-500 hover:bg-amber-600 text-black' }, 'VT'), React.createElement(ActionButton, { onClick: () => dispatch({ type: 'LOG_RHYTHM_TYPE', payload: 'PEA' }), className: 'bg-slate-600 hover:bg-slate-500 text-white' }, 'PEA'), React.createElement(ActionButton, { onClick: () => dispatch({ type: 'LOG_RHYTHM_TYPE', payload: 'Asystole' }), className: 'bg-slate-600 hover:bg-slate-500 text-white' }, 'Asystole'), React.createElement(ActionButton, { onClick: () => dispatch({ type: 'LOG_RHYTHM_TYPE', payload: 'ROSC' }), className: 'bg-green-600 hover:bg-green-700 text-white col-span-2' }, React.createElement(HeartPulseIcon), ' ROSC'));
                    case 'shock_advised':
                         return React.createElement(ActionSection, { title: 'Shock' }, React.createElement(ActionButton, { onClick: () => dispatch({ type: 'DELIVER_SHOCK' }), className: 'bg-amber-500 hover:bg-amber-600 text-black col-span-2' }, React.createElement(BoltIcon), 'Deliver Shock'));
                    default:
                        return React.createElement(React.Fragment, null, React.createElement(ActionSection, { title: 'Rhythm & Shock' }, React.createElement(ActionButton, { onClick: () => dispatch({ type: 'START_RHYTHM_ANALYSIS' }), className: 'bg-blue-600 hover:bg-blue-700 text-white col-span-2' }, React.createElement(BoltIcon), ' Analyse Rhythm')), React.createElement(ActionSection, { title: 'Medications' }, React.createElement(ActionButton, { onClick: () => dispatch({ type: 'LOG_ADRENALINE' }), className: 'bg-orange-500 hover:bg-orange-600 text-white', disabled: hypothermiaStatus === 'severe' }, React.createElement(SyringeIcon), ' Adrenaline'), React.createElement(ActionButton, { onClick: () => dispatch({ type: 'LOG_AMIODARONE' }), className: 'bg-purple-600 hover:bg-purple-700 text-white', disabled: state.shockCount < 3 || state.amiodaroneCount >= 2 || state.antiarrhythmicGiven === 'lidocaine' || hypothermiaStatus === 'severe' }, React.createElement(SyringeIcon), ' Amiodarone'), React.createElement(ActionButton, { onClick: () => dispatch({ type: 'LOG_LIDOCAINE' }), className: 'bg-pink-600 hover:bg-pink-700 text-white', disabled: state.shockCount < 3 || state.lidocaineCount >= 2 || state.antiarrhythmicGiven === 'amiodarone' }, React.createElement(SyringeIcon), ' Lidocaine'), React.createElement(ActionButton, { onClick: () => setShowOtherDrugsModal(true), className: 'bg-slate-600 hover:bg-slate-500 text-white' }, 'Other Meds...')), React.createElement(ActionSection, { title: 'Procedures' }, React.createElement(ActionButton, { onClick: () => dispatch({ type: 'LOG_AIRWAY' }), className: 'bg-indigo-600 hover:bg-indigo-700 text-white', disabled: state.airwayPlaced }, React.createElement(AirwayIcon), ' Advanced Airway'), React.createElement(ActionButton, { onClick: () => setShowEtco2Modal(true), className: 'bg-teal-600 hover:bg-teal-700 text-white' }, React.createElement(LungsIcon), ' Log ETCO2')), React.createElement(ActionSection, { title: 'Patient Status' }, React.createElement(ActionButton, { onClick: () => dispatch({ type: 'LOG_ROSC' }), className: 'bg-green-600 hover:bg-green-700 text-white' }, React.createElement(HeartPulseIcon), ' ROSC'), React.createElement(ActionButton, { onClick: () => setShowEndArrestModal(true), className: 'bg-red-800 hover:bg-red-700 text-white', disabled: state.arrestState === 'ENDED' }, React.createElement(StopIcon), ' End Arrest')));
                }
            };
            
            const totalArrestTime = state.masterTime + state.timeOffset;
            const showAmiodaroneReminder = state.amiodaroneCount === 1 && state.shockCount >= state.shockCountOnAmiodarone1 + 2;
            const adrenalineInterval = state.reversibleCauses.Hypothermia === 'moderate' ? HYPOTHERMIC_ADRENALINE_INTERVAL_SECONDS : ADRENALINE_INTERVAL_SECONDS;

            return React.createElement('div', { className: 'bg-gray-900 text-slate-100 min-h-screen font-sans flex flex-col' },
                showInstructions && React.createElement(InstructionsModal, { onClose: handleCloseInstructions }),
                showOtherDrugsModal && React.createElement(OtherDrugsModal, { onClose: () => setShowOtherDrugsModal(false), onSelectDrug: handleLogOtherDrug, drugs: OTHER_DRUGS }),
                showHypothermiaModal && React.createElement(HypothermiaModal, { onClose: () => setShowHypothermiaModal(false), onConfirm: handleSetHypothermiaStatus }),
                showSummary && React.createElement(SummaryModal, { events: state.events, masterTime: totalArrestTime, onClose: () => setShowSummary(false) }),
                showResetModal && React.createElement(ResetModal, { events: state.events, masterTime: totalArrestTime, onClose: () => setShowResetModal(false), onReset: handleReset }),
                showEndArrestModal && React.createElement(EndArrestModal, { onClose: () => setShowEndArrestModal(false), onConfirm: handleEndArrest }),
                showEtco2Modal && React.createElement(Etco2Modal, { onClose: () => setShowEtco2Modal(false), onConfirm: handleLogEtco2 }),
                
                React.createElement('header', { className: 'sticky top-0 bg-gray-900/80 backdrop-blur-sm p-4 flex justify-between items-start shadow-lg z-10 border-b border-gray-800' },
                    React.createElement('div', null, React.createElement('h1', { className: 'text-xl font-bold text-slate-200' }, 'eResus'), React.createElement('div', { className: 'mt-1' }, React.createElement(ArrestStatusIndicator, { status: state.arrestState }))),
                    React.createElement('div', { className: 'text-right' },
                        React.createElement('div', { className: 'flex justify-end items-center'},
                            state.timeOffset > 0 && React.createElement('span', { className: 'text-4xl font-mono tracking-tight text-amber-400' }, `${Math.floor(state.timeOffset / 60)}+`),
                            React.createElement('div', { 'aria-live': 'polite', className: `text-6xl font-mono tracking-tight ${state.arrestState === 'ROSC' ? 'text-green-400' : 'text-amber-400'}` }, formatTime(state.masterTime)),
                            (state.arrestState === 'PENDING' || state.arrestState === 'ACTIVE') && React.createElement(TimeOffsetButtons, { dispatch: dispatch })
                        ),
                        state.startTime && React.createElement('div', { className: 'flex justify-end items-baseline gap-x-4 gap-y-1 flex-wrap mt-1' }, React.createElement('div', { className: 'text-xs text-slate-400 font-semibold tracking-wider' }, 'SHOCKS: ', React.createElement('span', { className: 'text-amber-400 font-bold text-sm' }, state.shockCount)), React.createElement('div', { className: 'text-xs text-slate-400 font-semibold tracking-wider' }, 'ADRENALINE: ', React.createElement('span', { className: 'text-orange-400 font-bold text-sm' }, state.adrenalineCount)), React.createElement('div', { className: 'text-xs text-slate-400 font-semibold tracking-wider' }, 'AMIODARONE: ', React.createElement('span', { className: 'text-purple-400 font-bold text-sm' }, state.amiodaroneCount)), React.createElement('div', { className: 'text-xs text-slate-400 font-semibold tracking-wider' }, 'LIDOCAINE: ', React.createElement('span', { className: 'text-pink-400 font-bold text-sm' }, state.lidocaineCount))),
                        React.createElement('div', { className: 'text-xs text-slate-400 h-4 mt-1' }, state.startTime ? `Start Time: ${new Date(state.startTime).toLocaleTimeString()}` : 'Awaiting Start')
                    )
                ),
                
                React.createElement('main', { className: 'flex-grow p-4 space-y-4' },
                    state.arrestState === 'PENDING' ? ( React.createElement('div', { className: 'h-full flex items-center justify-center' }, React.createElement(ActionButton, { onClick: () => dispatch({ type: 'START_ARREST' }), className: 'bg-red-600 hover:bg-red-700 text-white h-36 text-3xl' }, 'Start Arrest')) ) : React.createElement(React.Fragment, null,
                        React.createElement('div', { className: 'bg-gray-800/50 rounded-lg p-4 flex items-center justify-around' }, React.createElement(CircularProgress, { cprTime: state.cprTime, cycleEnded: cprCycleEnded }), React.createElement('button', { onClick: () => dispatch({ type: 'TOGGLE_METRONOME' }), className: `p-4 rounded-full transition-colors self-center ${state.metronomeOn ? 'bg-green-600 text-white' : 'bg-gray-700 hover:bg-gray-600 text-slate-300'}` }, React.createElement(MusicNoteIcon))),
                        
                        React.createElement('div', { className: 'space-y-4' },
                            state.arrestState === 'ACTIVE' && React.createElement(AdrenalineTimer, { masterTime: totalArrestTime, lastAdrenalineTime: state.lastAdrenalineTime, interval: adrenalineInterval }),
                            state.arrestState === 'ACTIVE' && showAmiodaroneReminder && React.createElement(AmiodaroneReminder),
                            
                            state.arrestState === 'ROSC' ? React.createElement(React.Fragment, null, React.createElement(ActionSection, { title: 'Patient Status' }, React.createElement(ActionButton, { onClick: () => dispatch({ type: 'RE_ARREST'}), className: 'bg-amber-600 hover:bg-amber-700 text-white col-span-2' }, React.createElement(HeartPulseIcon), ' Patient Re-Arrested')), React.createElement(ActionSection, { title: 'Post-ROSC Medications' }, React.createElement(ActionButton, { onClick: () => setShowOtherDrugsModal(true), className: 'bg-slate-600 hover:bg-slate-500 text-white col-span-2' }, 'Administer Medication')), React.createElement(Checklist, { title: 'Post-ROSC Care', items: state.postRoscTasks, onToggle: (task) => dispatch({type: 'TOGGLE_POST_ROSC_TASK', payload: task}) })) : (state.arrestState === 'ACTIVE' ? renderActiveArrestActions() : null)
                        ),
                        
                        state.arrestState === 'ENDED' 
                            ? React.createElement(Checklist, { title: 'Actions Following Death', items: state.postMortemTasks, onToggle: (task) => dispatch({ type: 'TOGGLE_POST_MORTEM_TASK', payload: task })}) 
                            : (state.arrestState !== 'ROSC' && React.createElement(Checklist, { title: "4 H's & 4 T's", items: state.reversibleCauses, onToggle: (cause) => dispatch({ type: 'TOGGLE_REVERSIBLE_CAUSE', payload: cause }), onHypothermiaClick: () => setShowHypothermiaModal(true) })),
                        
                        React.createElement('div', { className: 'bg-gray-800/50 rounded-lg p-4 h-72 flex flex-col' }, React.createElement('h2', { className: 'text-lg font-bold mb-2 flex-shrink-0 text-slate-200' }, 'Event Log'), React.createElement('div', { ref: logContainerRef, className: 'overflow-y-auto flex-grow pr-2' }, React.createElement('ul', { className: 'space-y-2 text-base' }, state.events.slice().reverse().map((event, index) => React.createElement('li', { key: index, className: 'flex items-baseline' }, React.createElement('span', { className: `font-mono mr-3 ${getLogColorClass(event.type)}` }, `[${formatTime(event.timestamp)}]`), React.createElement('span', { className: 'text-slate-300' }, event.message)))))),

                        React.createElement(ResuscitationCouncilAlgorithms, { arrestState: state.arrestState })
                    )
                ),
                
                state.arrestState !== 'PENDING' && React.createElement('footer', { className: 'sticky bottom-0 bg-gray-900/80 backdrop-blur-sm p-3 flex gap-3 z-10 border-t border-gray-800' }, React.createElement('button', { onClick: () => dispatch({ type: 'UNDO' }), className: 'flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg disabled:opacity-50', disabled: !state.previousState }, 'Undo'), React.createElement('button', { onClick: () => setShowSummary(true), className: 'flex-1 bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg disabled:opacity-50', disabled: state.events.length === 0 }, 'View Summary'), React.createElement('button', { onClick: () => setShowResetModal(true), className: 'flex-1 bg-red-800/80 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg' }, 'Reset'))
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(React.StrictMode, null, React.createElement(App)));
    </script>
</body>
</html>
